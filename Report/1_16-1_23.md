# FAAP 연구 진행 보고서 (1/16 ~ 1/23)

---

## 개요

이 기간 동안 **AP Gap 개선**을 위한 다양한 접근 방식을 실험하였습니다.

### 기준선 (7th 결과)

| 지표 | Baseline | Perturbed | Gap |
|------|----------|-----------|-----|
| Male AP | 0.511 | 0.514 | - |
| Female AP | 0.405 | 0.408 | - |
| **AP Gap** | 0.106 | 0.106 | 변화 없음 |
| AR Gap | 0.008 | 0.003 | **60% 개선** |

**문제**: AR Gap은 개선되었지만, **AP Gap은 거의 변화 없음**

---

## 일별 작업 내역

### 1/17 (금) - DINO Self-Distillation

**커밋**: `a2376f8` - train_dino_1st

**파일**:
- `train_faap_dino_1st.py` (신규)
- `train_dino_1st.log`

**접근 방식**:
- DINO 논문의 Self-Distillation 프레임워크 적용
- Teacher (남성) → Student (여성) distillation
- Centering으로 collapse 방지
- EMA Teacher로 안정적인 타겟 제공

**핵심 컴포넌트**:
- `DINOHead`: Score → Projection
- `DINOCenter`: Running mean으로 centering
- `EMATeacher`: Momentum 0.996 → 1.0

**결과**: 실험 진행 중

---

### 1/20 (월) - 14th + Contrastive IoU

**커밋**: `3098131` - claude.md iou 버전은 무시 14th wgan gd 버전 커밋

**파일**:
- `train_faap_wgan_GD_14th.py` (신규)
- `train_faap_contrastive_iou.py` (신규, 무시)
- `research_contrastive_fairness.md` (신규)
- `claude.md` (수정)

**14th 접근 방식**:
AP Gap을 직접 공략하는 4가지 새로운 Loss:

| Loss | Weight | 설명 |
|------|--------|------|
| Quantile-Weighted Wasserstein | 0.2 | 상위 30%에 2배 가중치 |
| Confidence Margin | 0.1 | Female ≥ Male - margin |
| Direct Score Gap | 0.15 | 평균 score gap 직접 패널티 |
| Female Det Scale | 1.2x | Female detection 강화 |

**Contrastive IoU** (무시 대상):
- IoU gap이 원래 없었음 (M: 0.770, F: 0.766)
- Feature alignment가 AP에 직접 영향 못 줌

---

### 1/21 (화) - SimCLR InfoNCE (실패) + Score-based Contrastive (제안)

**커밋**: `12817ad` - SimCLR InfoNCE 실험(실패) + Score-based Contrastive 제안

**파일**:
- `train_faap_simclr_infonce.py` (신규) - **실패**
- `train_faap_score_contrastive.py` (신규) - **제안**
- `related_papers_for_faap.md` (신규)
- `claude.md` (수정)

#### SimCLR InfoNCE (실패)

**결과**: AP Gap 0.106 → 0.110 (**악화**)

**실패 원인**:
1. Cross-gender를 positive로 정의했지만 semantic 유사성 없음
2. 목표(AP Gap)와 방법(feature similarity)이 연결 안됨
3. 모든 feature를 같게 만들려다 다양성 손실

#### Score-based Contrastive (제안)

**핵심 아이디어**:
- 성별이 아닌 **detection score**를 기준으로 positive/anchor 정의
- High-score → Positive (목표)
- Low-score → Anchor (이동 대상)
- Anchor feature를 Positive 방향으로 이동

---

### 1/23 (목) - Score-based Contrastive v2 + 평가

**상태**: 아직 커밋되지 않음

**파일**:
- `train_faap_score_contrastive.py` (수정)
- `train_faap_score_contrastive.md` (신규)

**v1 → v2 개선**:

| 항목 | v1 | v2 |
|------|-----|-----|
| Threshold | 고정 (0.5) | **배치 내 상대적 ranking** |
| 문제 | Score 대부분 0.9+ → Anchor 없음 | 상위/하위 K%로 균형 보장 |
| 추가 | - | Contrastive warmup |

**평가 결과 (epoch 29)**:

| 지표 | Baseline | Perturbed | Delta |
|------|----------|-----------|-------|
| Male AP | 0.511 | 0.519 | +0.008 |
| Female AP | 0.404 | 0.414 | +0.009 |
| **AP Gap** | **0.1063** | **0.1049** | **-0.0014 (-1.3%)** |

**결론**: AP Gap이 소폭 감소했으나 개선 폭이 크지 않음

---

## 실험 요약

| 날짜 | 접근 방식 | 상태 | AP Gap 결과 |
|------|-----------|------|-------------|
| 1/17 | DINO Self-Distillation | 진행 중 | - |
| 1/20 | 14th (AP Gap 직접 공략) | 대기 | - |
| 1/20 | Contrastive IoU | **무시** | - |
| 1/21 | SimCLR InfoNCE | **실패** | 0.106 → 0.110 |
| 1/21 | Score-based Contrastive v1 | 완료 | - |
| 1/23 | Score-based Contrastive v2 | **완료** | 0.106 → 0.105 (-1.3%) |

---

## 파일 목록

### 커밋된 파일

| 파일 | 날짜 | 설명 |
|------|------|------|
| train_faap_dino_1st.py | 1/17 | DINO Self-Distillation |
| train_faap_wgan_GD_14th.py | 1/20 | AP Gap 직접 공략 |
| train_faap_contrastive_iou.py | 1/20 | IoU Contrastive (무시) |
| train_faap_simclr_infonce.py | 1/21 | Cross-Gender InfoNCE (실패) |
| train_faap_score_contrastive.py | 1/21 | Score-based Contrastive |
| related_papers_for_faap.md | 1/21 | 관련 논문 정리 |
| research_contrastive_fairness.md | 1/20 | Contrastive Fairness 연구 |

### 미커밋 파일

| 파일 | 설명 |
|------|------|
| train_faap_score_contrastive.py | v2 수정 (adaptive ranking) |
| train_faap_score_contrastive.md | 분석 문서 |
| train_faap_simclr_infonce.md | 분석 문서 |
| train_faap_dino_1st.md | 분석 문서 |
| train_faap_wgan_GD_14th.md | 분석 문서 |

---

## 교훈 및 인사이트

### 실패에서 배운 것

1. **Cross-Gender Contrastive는 효과 없음**
   - 성별 간 semantic 유사성이 없어 positive pair로 부적합
   - Feature를 가깝게 만든다고 detection 성능이 같아지지 않음

2. **IoU Gap은 원래 없었음**
   - Male IoU: 0.770, Female IoU: 0.766 (차이 미미)
   - AP Gap의 원인이 IoU가 아님

### 유망한 방향

1. **Score-based Contrastive**
   - 성별 대신 detection quality(score)를 기준으로
   - 저품질 detection을 고품질 방향으로 이동

2. **AP Gap 직접 공략 (14th)**
   - Quantile-weighted Wasserstein
   - High-confidence 영역에 집중

3. **DINO Self-Distillation**
   - Collapse 방지하면서 분포 정렬
   - 아직 평가 필요

---

## 다음 단계

1. **14th 학습 및 평가**
   - AP Gap 직접 공략 방식의 효과 확인

2. **DINO 평가**
   - Self-Distillation 방식의 효과 확인

3. **하이브리드 접근**
   - Score-based Contrastive + 14th Loss 결합 고려

---

## 목표 대비 현황

| 목표 | 현재 최선 | 달성률 |
|------|-----------|--------|
| AP Gap < 0.09 (15% 개선) | 0.105 (1.3% 개선) | 8.7% |
| Female AP > 0.41 | 0.414 | **달성** |
| AR Gap 유지 | 유지 | **달성** |
