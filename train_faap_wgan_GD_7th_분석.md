# FAAP-GAN 7ì°¨ ì‹¤í—˜ ìš”ì•½ ë° ë¶„ì„

## ğŸ“‹ ëª©ì°¨
1. [ì´ì „ ì‹¤í—˜ ê´€ì°° ê²°ê³¼](#ì´ì „-ì‹¤í—˜-ê´€ì°°-ê²°ê³¼)
2. [7ì°¨ ì„¤ê³„ ëª©í‘œ](#7ì°¨-ì„¤ê³„-ëª©í‘œ)
3. [ì‹¤í—˜ ê²°ê³¼ ë¶„ì„](#ì‹¤í—˜-ê²°ê³¼-ë¶„ì„)
4. [íŒŒì´í”„ë¼ì¸ êµ¬ì¡°](#íŒŒì´í”„ë¼ì¸-êµ¬ì¡°)
5. [í•µì‹¬ ëª¨ë“ˆ ì„¤ëª…](#í•µì‹¬-ëª¨ë“ˆ-ì„¤ëª…)
6. [ì‹¤í–‰ ëª…ë ¹ì–´](#ì‹¤í–‰-ëª…ë ¹ì–´)

---

## ì´ì „ ì‹¤í—˜ ê´€ì°° ê²°ê³¼

| ì‹¤í—˜ | ê²°ê³¼ | ë¬¸ì œì  |
|------|------|--------|
| **4ì°¨** | ì „ë°˜ì ìœ¼ë¡œ ê°€ì¥ ê°•í•¨ (Female AR, ê°€ì¥ ì‘ì€ Gap) | - |
| **5ì°¨** | ì„±ë³„ë‹¹ ìƒ˜í”Œ ìˆ˜ ì œí•œì´ ë„ì›€ ì•ˆë¨ | ë°ì´í„° ê°ì†Œë¡œ ì¸í•œ ì„±ëŠ¥ ì €í•˜ |
| **6ì°¨** | cooldown + beta ìŠ¤ì¼€ì¤„ì´ 4ì°¨ë¥¼ ì´ê¸°ì§€ ëª»í•¨ | ì§§ì€ í•™ìŠµ ì‹œê°„ |
| **6ì°¨_2** | stress windowê°€ AP/Gap ì•…í™” | ê³¼ë„í•œ perturbation |

---

## 7ì°¨ ì„¤ê³„ ëª©í‘œ

4ì°¨ì˜ í•µì‹¬(ë‹¨ë°©í–¥ Wasserstein)ì„ ìœ ì§€í•˜ë©´ì„œ **ë³´ìˆ˜ì ì´ê³  í›„ë°˜ë¶€ì— ì•ˆì •í™”**í•˜ëŠ” ì „ëµ ì ìš©.
â†’ Female ì„±ëŠ¥ í–¥ìƒì„ ìœ ì§€í•˜ë©´ì„œ Detection ì„±ëŠ¥ íšŒë³µ.

### 1) ê¸´ í•™ìŠµ + ì ì§„ì  epsilon ì¿¨ë‹¤ìš´
- ê¸°ë³¸ `epochs=24` (4ì°¨ ìµœê³  ì„±ëŠ¥ ê¸¸ì´ì™€ ë™ì¼)
- Epsilon ìŠ¤ì¼€ì¤„ (6ì°¨ ì•„ì´ë””ì–´ë¥¼ ë¶€ë“œëŸ½ê²Œ ì ìš©):
  - **warmup 8ì—í­** â†’ **hold 6ì—í­** â†’ **cooldown 10ì—í­**
  - `epsilon_final=0.10`, `epsilon_min=0.09`
- **ëª©ì **: ì´ˆë°˜ì— ê³µì •ì„± ì‹ í˜¸ ìœ ì§€, í›„ë°˜ì— ê²€ì¶œ ì„±ëŠ¥ íšŒë³µ

### 2) ì™„ë§Œí•œ ê²€ì¶œ ê°€ì¤‘ì¹˜ ì¦ê°€
- `beta: 0.5 â†’ 0.6` ì„ í˜• ì¦ê°€ (6ì°¨ë³´ë‹¤ ê°€ë³ê²Œ)
- **ëª©ì **: í›„ë°˜ ì—í­ì—ì„œ ê²€ì¶œ ì„±ëŠ¥ ë³´ì¡´

### 3) ë‚¨ì„± ê³µì •ì„± ê°€ì¤‘ì¹˜ ê°ì†Œ
- `fair_m_scale=0.5` (Femaleì€ 1.0 ìœ ì§€)
- **ëª©ì **: ë¶ˆí•„ìš”í•œ ë‚¨ì„± perturbation ê°ì†Œ, ë‚¨ì„± AP/AR ë³´í˜¸

### 4) ëª¨ë‹ˆí„°ë§
- ì„±ë³„ë³„ `obj_score/obj_frac` ë¡œê¹… ìœ ì§€ (6ì°¨ì—ì„œ ê°€ì ¸ì˜´)

### 5) ì„ íƒì  ì„±ë³„ë‹¹ ìƒ˜í”Œ ì œí•œ
- `--max_train_per_gender` ì¶”ê°€ (ê¸°ë³¸ê°’ 0: ë¹„í™œì„±í™”)
- ë°˜ë³µ ìƒ˜í”Œë§ì´ ë¬¸ì œë  ë•Œë§Œ ì‚¬ìš©

---

## ì‹¤í—˜ ê²°ê³¼ ë¶„ì„

### ğŸ† 7ì°¨ ì‹¤í—˜ ìµœì¢… ì„±ê³¼

#### ì„±ëŠ¥ ë³€í™” (Baseline â†’ Perturbed)

| ì§€í‘œ | Baseline | Perturbed | Delta | **í–¥ìƒë¥ ** |
|------|----------|-----------|-------|----------|
| Male AP | 0.5108 | 0.5137 | +0.0029 | **+0.57%** |
| Female AP | 0.4045 | 0.4078 | +0.0034 | **+0.83%** |
| Male AR | 0.8339 | 0.8359 | +0.0021 | **+0.25%** |
| Female AR | 0.8258 | 0.8328 | +0.0070 | **+0.85%** |

#### ê³µì •ì„± ê°œì„  (ì„±ë³„ Gap ë³€í™”)

| ì§€í‘œ | Baseline Gap | Perturbed Gap | **Gap ê°ì†Œìœ¨** |
|------|--------------|---------------|----------------|
| AP Gap (M-F) | 0.1063 | 0.1059 | **-0.38%** |
| AR Gap (M-F) | 0.0081 | 0.0032 | **-60.5%** ğŸ¯ |

### í•µì‹¬ ì„±ê³¼ ìš”ì•½
1. âœ… **ì„±ëŠ¥ ì†ì‹¤ ì—†ìŒ**: ëª¨ë“  ì§€í‘œì—ì„œ ì–‘ìˆ˜ delta (ì˜¤íˆë ¤ í–¥ìƒ)
2. âœ… **AR ê³µì •ì„± 60% ê°œì„ **: ì„±ë³„ ê²©ì°¨ ëŒ€í­ ê°ì†Œ
3. âœ… **Female ê·¸ë£¹ ë” í° í–¥ìƒ**: ê¸°ì¡´ ì•½ì ê·¸ë£¹ì˜ ì„±ëŠ¥ì´ ë” ë§ì´ ê°œì„ 

---

## íŒŒì´í”„ë¼ì¸ êµ¬ì¡°

### ì „ì²´ í•™ìŠµ íë¦„ë„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           FAAP-GAN 7ì°¨ í•™ìŠµ íŒŒì´í”„ë¼ì¸                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  [1] ë°ì´í„° ë¡œë”©                                                             â”‚
â”‚      â”œâ”€â”€ FAAP ë°ì´í„°ì…‹ ë¡œë“œ (ë‚¨/ì—¬ ê· í˜• ìƒ˜í”Œë§)                               â”‚
â”‚      â””â”€â”€ ë°°ì¹˜ ë‹¨ìœ„ë¡œ ì„±ë³„ ë¶„ë¦¬                                                â”‚
â”‚                                                                             â”‚
â”‚  [2] Discriminator í•™ìŠµ (k_d=4íšŒ ë°˜ë³µ)                                       â”‚
â”‚      â”œâ”€â”€ Generatorë¡œ perturbation ìƒì„± (no grad)                            â”‚
â”‚      â”œâ”€â”€ DETRë¡œ feature ì¶”ì¶œ (frozen)                                       â”‚
â”‚      â”œâ”€â”€ Discriminatorê°€ ì„±ë³„ ë¶„ë¥˜                                          â”‚
â”‚      â””â”€â”€ Cross-Entropy Lossë¡œ D ì—…ë°ì´íŠ¸                                    â”‚
â”‚                                                                             â”‚
â”‚  [3] Generator í•™ìŠµ                                                         â”‚
â”‚      â”œâ”€â”€ perturbation ìƒì„± â†’ ì´ë¯¸ì§€ì— ì ìš©                                  â”‚
â”‚      â”œâ”€â”€ DETR feature ì¶”ì¶œ                                                  â”‚
â”‚      â”œâ”€â”€ ì†ì‹¤ ê³„ì‚°:                                                         â”‚
â”‚      â”‚   â”œâ”€â”€ Fairness Loss (Adversarial + Entropy)                         â”‚
â”‚      â”‚   â”œâ”€â”€ Detection Loss (DETR ê²€ì¶œ ìœ ì§€)                                â”‚
â”‚      â”‚   â””â”€â”€ Wasserstein Loss (Femaleâ†’Male ë‹¨ë°©í–¥)                          â”‚
â”‚      â””â”€â”€ Generator ì—…ë°ì´íŠ¸                                                 â”‚
â”‚                                                                             â”‚
â”‚  [4] ìŠ¤ì¼€ì¤„ë§                                                               â”‚
â”‚      â”œâ”€â”€ Epsilon: warmup â†’ hold â†’ cooldown                                 â”‚
â”‚      â””â”€â”€ Beta: ì„ í˜• ì¦ê°€ (0.5 â†’ 0.6)                                       â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ìƒì„¸ ë°ì´í„° íë¦„

```
ì…ë ¥ ì´ë¯¸ì§€ (X)
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Generator G   â”‚  â† epsilon ìŠ¤ì¼€ì¤„ì— ë”°ë¼ perturbation í¬ê¸° ì¡°ì ˆ
â”‚  (Perturbation) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚ Î´ = G(X)
         â–¼
    X' = X + Î´ (perturbed ì´ë¯¸ì§€)
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Frozen DETR   â”‚  â† ì‚¬ì „í•™ìŠµëœ Object Detection ëª¨ë¸ (ê°€ì¤‘ì¹˜ ê³ ì •)
â”‚  (Feature ì¶”ì¶œ) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚         â”‚
    â–¼         â–¼
 Features   Detection
    â”‚        Outputs
    â”‚           â”‚
    â–¼           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Discrim.â”‚  â”‚Detection   â”‚
â”‚(ì„±ë³„   â”‚  â”‚Loss ê³„ì‚°   â”‚
â”‚ë¶„ë¥˜)   â”‚  â”‚            â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
    â”‚             â”‚
    â–¼             â–¼
Fairness      Detection
Loss          Loss (Î²)
    â”‚             â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Wasserstein â”‚  â† Female scoreë¥¼ Male ìˆ˜ì¤€ìœ¼ë¡œ ëŒì–´ì˜¬ë¦¼
    â”‚    Loss     â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    Total Loss = Î»_fair * Fairness + Î² * Detection + Î»_w * Wasserstein
           â”‚
           â–¼
    Generator ì—…ë°ì´íŠ¸ (Backpropagation)
```

---

## í•µì‹¬ ëª¨ë“ˆ ì„¤ëª…

### 1. PerturbationGenerator (ìƒì„±ê¸°)

**ì—­í• **: ì…ë ¥ ì´ë¯¸ì§€ì— ë¯¸ì„¸í•œ perturbationì„ ì¶”ê°€í•˜ì—¬ DETRì˜ ì„±ë³„ í¸í–¥ì„ ì¤„ì„

```python
class PerturbationGenerator(nn.Module):
    """
    ì…ë ¥: ì •ê·œí™”ëœ ì´ë¯¸ì§€ í…ì„œ [B, 3, H, W]
    ì¶œë ¥: perturbation Î´ [B, 3, H, W]
    
    êµ¬ì¡°:
    - Encoder: ì´ë¯¸ì§€ â†’ ì ì¬ í‘œí˜„ (downsampling)
    - Decoder: ì ì¬ í‘œí˜„ â†’ perturbation (upsampling)
    - tanh í™œì„±í™”ë¡œ [-epsilon, +epsilon] ë²”ìœ„ ì œí•œ
    """
    
    def forward(self, x):
        # 1. ì¸ì½”ë”©: íŠ¹ì§• ì¶”ì¶œ
        features = self.encoder(x)  # [B, 256, H/4, W/4]
        
        # 2. ë””ì½”ë”©: perturbation ìƒì„±
        delta = self.decoder(features)  # [B, 3, H, W]
        
        # 3. í¬ê¸° ì œí•œ: epsilon ë²”ìœ„ ë‚´ë¡œ í´ë¨í•‘
        delta = torch.tanh(delta) * self.epsilon
        
        return delta

# ì˜ˆì‹œ:
# ì…ë ¥ ì´ë¯¸ì§€: [4, 3, 800, 1333] (ë°°ì¹˜ 4, RGB, COCO í•´ìƒë„)
# epsilon = 0.1ì¼ ë•Œ
# ì¶œë ¥ Î´: [-0.1, +0.1] ë²”ìœ„ì˜ [4, 3, 800, 1333] í…ì„œ
# ì ìš©: perturbed_image = original_image + Î´
```

### 2. GenderDiscriminator (íŒë³„ê¸°)

**ì—­í• **: DETR featureë¡œë¶€í„° ì„±ë³„ì„ ë¶„ë¥˜ (Generatorê°€ ì†ì´ë ¤ëŠ” ëŒ€ìƒ)

```python
class GenderDiscriminator(nn.Module):
    """
    ì…ë ¥: DETRì˜ backbone feature [B, hidden_dim]
    ì¶œë ¥: ì„±ë³„ logits [B, 2] (0=Male, 1=Female)
    
    êµ¬ì¡°:
    - MLP: 256 â†’ 128 â†’ 64 â†’ 2
    - LeakyReLU í™œì„±í™”
    """
    
    def forward(self, features):
        # Global Average Pooling í›„ MLP í†µê³¼
        x = self.fc1(features)      # [B, 128]
        x = F.leaky_relu(x, 0.2)
        x = self.fc2(x)             # [B, 64]
        x = F.leaky_relu(x, 0.2)
        logits = self.fc3(x)        # [B, 2]
        return logits

# ì˜ˆì‹œ:
# DETR feature: [4, 256] (ë°°ì¹˜ 4, hidden_dim=256)
# ì¶œë ¥ logits: [[0.8, 0.2], [0.3, 0.7], ...] 
# â†’ softmax í›„ ì„±ë³„ í™•ë¥ 
```

### 3. FrozenDETR (ë™ê²°ëœ ê²€ì¶œê¸°)

**ì—­í• **: ì‚¬ì „í•™ìŠµëœ DETRì„ feature ì¶”ì¶œ ë° ê²€ì¶œ ì„±ëŠ¥ í‰ê°€ì— ì‚¬ìš©

```python
class FrozenDETR:
    """
    íŠ¹ì§•:
    - ëª¨ë“  íŒŒë¼ë¯¸í„° frozen (í•™ìŠµ ì•ˆí•¨)
    - Object Detection ê²°ê³¼ + backbone feature ë™ì‹œ ë°˜í™˜
    
    ë©”ì„œë“œ:
    - forward_with_features(): ê²€ì¶œ ê²°ê³¼ + feature ë°˜í™˜
    - detection_loss(): ê²€ì¶œ ì†ì‹¤ ê³„ì‚° (Hungarian matching)
    """
    
    def forward_with_features(self, samples):
        # 1. Backboneìœ¼ë¡œ feature ì¶”ì¶œ
        features = self.backbone(samples.tensors)
        
        # 2. Transformerë¡œ object query ì²˜ë¦¬
        outputs = self.transformer(features)
        
        # 3. ê²€ì¶œ ê²°ê³¼ ë°˜í™˜
        return {
            "pred_logits": ...,  # [B, 100, 92] í´ë˜ìŠ¤ í™•ë¥ 
            "pred_boxes": ...    # [B, 100, 4] ë°”ìš´ë”© ë°•ìŠ¤
        }, pooled_features

# ì˜ˆì‹œ:
# ì…ë ¥: perturbed ì´ë¯¸ì§€ [4, 3, 800, 1333]
# ì¶œë ¥ pred_logits: [4, 100, 92] (ë°°ì¹˜ 4, ì¿¼ë¦¬ 100ê°œ, COCO 91í´ë˜ìŠ¤+ë°°ê²½)
# ì¶œë ¥ pred_boxes: [4, 100, 4] (cx, cy, w, h ì •ê·œí™” ì¢Œí‘œ)
```

### 4. ì†ì‹¤ í•¨ìˆ˜ë“¤

#### (a) Fairness Loss (ê³µì •ì„± ì†ì‹¤)

```python
def compute_fairness_loss(logits, target_gender, alpha=0.2):
    """
    ëª©ì : Generatorê°€ Discriminatorë¥¼ ì†ì´ë„ë¡ í•™ìŠµ
    
    êµ¬ì„±:
    1. Adversarial Loss: Dê°€ í‹€ë¦° ì„±ë³„ë¡œ ë¶„ë¥˜í•˜ê²Œ ë§Œë“¦
    2. Entropy Loss: Dì˜ ì¶œë ¥ì„ ë¶ˆí™•ì‹¤í•˜ê²Œ ë§Œë“¦ (ê· ë“± ë¶„í¬)
    
    ìˆ˜ì‹: L_fair = -(CE + Î± * Entropy)
    """
    # Cross-Entropy: ë°˜ëŒ€ ì„±ë³„ë¡œ ë¶„ë¥˜ë˜ê¸¸ ì›í•¨
    ce_loss = F.cross_entropy(logits, target_gender)
    
    # Entropy: í™•ë¥  ë¶„í¬ê°€ ê· ë“±í• ìˆ˜ë¡ ë†’ìŒ
    probs = torch.softmax(logits, dim=-1)
    entropy = -(probs * torch.log(probs + 1e-8)).sum(dim=-1).mean()
    
    # ìŒìˆ˜ë¡œ ë°˜í™˜ (ìµœëŒ€í™” â†’ ìµœì†Œí™”)
    return -(ce_loss + alpha * entropy)

# ì˜ˆì‹œ:
# Female ë°°ì¹˜ì˜ ê²½ìš°:
# - Dê°€ "Female"ë¡œ ë¶„ë¥˜ â†’ CE ë‚®ìŒ â†’ G ì†ì‹¤ ë†’ìŒ (ë‚˜ì¨)
# - Dê°€ "Male"ë¡œ ë¶„ë¥˜ â†’ CE ë†’ìŒ â†’ G ì†ì‹¤ ë‚®ìŒ (ì¢‹ìŒ)
# - Dê°€ [0.5, 0.5] ì¶œë ¥ â†’ Entropy ìµœëŒ€ â†’ G ì†ì‹¤ ë‚®ìŒ (ì¢‹ìŒ)
```

#### (b) Detection Loss (ê²€ì¶œ ì†ì‹¤)

```python
def detection_loss(outputs, targets):
    """
    ëª©ì : perturbationì´ ê²€ì¶œ ì„±ëŠ¥ì„ í•´ì¹˜ì§€ ì•Šë„ë¡ ì œì•½
    
    êµ¬ì„±:
    1. Hungarian Matching: ì˜ˆì¸¡-GT ìµœì  ë§¤ì¹­
    2. Classification Loss: ì˜¬ë°”ë¥¸ í´ë˜ìŠ¤ ë¶„ë¥˜
    3. Box Loss: ì •í™•í•œ ìœ„ì¹˜ ì˜ˆì¸¡ (L1 + GIoU)
    
    ìˆ˜ì‹: L_det = L_cls + L_box
    """
    # DETRì˜ SetCriterion ì‚¬ìš©
    indices = matcher(outputs, targets)  # ìµœì  ë§¤ì¹­
    
    loss_ce = class_loss(outputs, targets, indices)
    loss_bbox = bbox_loss(outputs, targets, indices)
    
    return loss_ce + loss_bbox

# ì˜ˆì‹œ:
# ì›ë³¸ì—ì„œ person 3ëª… ê²€ì¶œ â†’ perturbedì—ì„œë„ 3ëª… ê²€ì¶œ ìœ ì§€
# Î²=0.5~0.6ìœ¼ë¡œ ê°€ì¤‘ì¹˜ ì¡°ì ˆí•˜ì—¬ ê³µì •ì„±ê³¼ ê· í˜•
```

#### (c) Wasserstein Loss (ë‹¨ë°©í–¥ ë¶„í¬ ì •ë ¬)

```python
def _wasserstein_1d(female_scores, male_scores):
    """
    ëª©ì : Female ê²€ì¶œ ì ìˆ˜ë¥¼ Male ìˆ˜ì¤€ìœ¼ë¡œ ëŒì–´ì˜¬ë¦¼
    
    í•µì‹¬: ë‹¨ë°©í–¥ (Female â†’ Male)ë§Œ ì ìš©
    - Female < Maleì¼ ë•Œë§Œ ì†ì‹¤ ë°œìƒ
    - Female >= Maleì´ë©´ ì†ì‹¤ 0 (ë‚¨ì„± ì„±ëŠ¥ ë³´í˜¸)
    
    ìˆ˜ì‹: L_w = mean(ReLU(sorted_male - sorted_female))
    """
    # ì ìˆ˜ ì •ë ¬
    sorted_f = female_scores.sort().values
    sorted_m = male_scores.detach().sort().values  # Maleì€ íƒ€ê²Ÿ (detach)
    
    # í¬ê¸° ë§ì¶”ê¸° (interpolation)
    k = max(len(sorted_f), len(sorted_m))
    sorted_f = resize(sorted_f, k)
    sorted_m = resize(sorted_m, k)
    
    # ë‹¨ë°©í–¥ ì†ì‹¤: Femaleì´ Maleë³´ë‹¤ ë‚®ì„ ë•Œë§Œ íŒ¨ë„í‹°
    return F.relu(sorted_m - sorted_f).mean()

# ì˜ˆì‹œ:
# Female scores: [0.3, 0.5, 0.7] (ì •ë ¬ë¨)
# Male scores:   [0.4, 0.6, 0.8] (ì •ë ¬ë¨, detach)
# ì°¨ì´: [0.1, 0.1, 0.1] â†’ ëª¨ë‘ ì–‘ìˆ˜ â†’ ì†ì‹¤ = 0.1
# 
# ë§Œì•½ Female scores: [0.5, 0.7, 0.9]
# ì°¨ì´: [-0.1, -0.1, -0.1] â†’ ReLU í›„ 0 â†’ ì†ì‹¤ = 0
# â†’ Femaleì´ ì´ë¯¸ ë†’ìœ¼ë©´ ë” ë†’ì´ë ¤ê³  í•˜ì§€ ì•ŠìŒ!
```

### 5. Epsilon ìŠ¤ì¼€ì¤„ëŸ¬

```python
def _scheduled_epsilon(epoch, warmup, hold, cooldown, start, peak, min_eps):
    """
    Epsilon ë³€í™” ê³¡ì„ :
    
    epsilon
      â”‚
   peak â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚        /            \
      â”‚       /              \
      â”‚      /                \
   min â”€â”€â”€â”€â”€/                  \â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ epoch
           warmup   hold   cooldown
           (8)      (6)    (10)
    
    ë‹¨ê³„:
    1. Warmup (0~7): 0.05 â†’ 0.10 ì„ í˜• ì¦ê°€
    2. Hold (8~13): 0.10 ìœ ì§€
    3. Cooldown (14~23): 0.10 â†’ 0.09 ì„ í˜• ê°ì†Œ
    """
    if epoch <= warmup - 1:
        # Warmup ë‹¨ê³„: ì„ í˜• ì¦ê°€
        progress = epoch / (warmup - 1)
        return start + (peak - start) * progress
    
    elif epoch <= warmup + hold - 1:
        # Hold ë‹¨ê³„: peak ìœ ì§€
        return peak
    
    else:
        # Cooldown ë‹¨ê³„: ì„ í˜• ê°ì†Œ
        progress = (epoch - warmup - hold) / cooldown
        return peak + (min_eps - peak) * min(progress, 1.0)

# ì˜ˆì‹œ (24 ì—í­ í•™ìŠµ):
# Epoch 0:  Îµ = 0.05 (ì‹œì‘)
# Epoch 4:  Îµ = 0.075 (warmup ì¤‘ê°„)
# Epoch 8:  Îµ = 0.10 (peak ë„ë‹¬)
# Epoch 13: Îµ = 0.10 (hold ìœ ì§€)
# Epoch 18: Îµ = 0.095 (cooldown ì¤‘ê°„)
# Epoch 23: Îµ = 0.09 (ìµœì¢…)
```

### 6. Beta ìŠ¤ì¼€ì¤„ëŸ¬

```python
def _scheduled_beta(epoch, total_epochs, beta_start, beta_final):
    """
    Detection Loss ê°€ì¤‘ì¹˜ ë³€í™”:
    
    beta
      â”‚
   0.6 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€/
      â”‚                              /
      â”‚                           /
      â”‚                        /
   0.5 â”€â”€â”€â”€â”€/â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€/
      â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ epoch
           0                          23
    
    ëª©ì : í›„ë°˜ë¶€ë¡œ ê°ˆìˆ˜ë¡ ê²€ì¶œ ì„±ëŠ¥ ë³´ì¡´ ê°•í™”
    """
    progress = epoch / (total_epochs - 1)
    return beta_start + (beta_final - beta_start) * progress

# ì˜ˆì‹œ:
# Epoch 0:  Î² = 0.50
# Epoch 12: Î² = 0.55
# Epoch 23: Î² = 0.60
```

---

## ì‹¤í–‰ ëª…ë ¹ì–´

### í•™ìŠµ ì‹¤í–‰
```bash
python train_faap_wgan_GD_7th.py \
  --epochs 24 \
  --epsilon_final 0.10 \
  --epsilon_min 0.09 \
  --epsilon_warmup_epochs 8 \
  --epsilon_hold_epochs 6 \
  --epsilon_cooldown_epochs 10 \
  --beta 0.5 \
  --beta_final 0.6 \
  --fair_m_scale 0.5
```

### í‰ê°€ ì‹¤í–‰
```bash
python eval_faap.py \
  --dataset_root /home/dohyeong/Desktop/faap_dataset \
  --detr_checkpoint /home/dohyeong/Desktop/detr/detr-r50-e632da11.pth \
  --generator_checkpoint /home/dohyeong/Desktop/faap_gan/faap_outputs/faap_outputs_gd_7th/checkpoints/epoch_0023.pth \
  --epsilon 0.09 \
  --split test \
  --results_path faap_outputs/faap_outputs_gd_7th/test_metrics_epoch_0023.json
```

**ì£¼ì˜**: í‰ê°€ ì‹œ `--epsilon`ì€ í•´ë‹¹ ì²´í¬í¬ì¸íŠ¸ ì—í­ì˜ ìŠ¤ì¼€ì¤„ ê°’ê³¼ ì¼ì¹˜ì‹œì¼œì•¼ í•¨

---

## í•˜ì´í¼íŒŒë¼ë¯¸í„° ìš”ì•½

| íŒŒë¼ë¯¸í„° | ê°’ | ì„¤ëª… |
|----------|------|------|
| `epochs` | 24 | ì´ í•™ìŠµ ì—í­ |
| `epsilon` | 0.05 â†’ 0.10 â†’ 0.09 | perturbation í¬ê¸° (warmup â†’ hold â†’ cooldown) |
| `beta` | 0.5 â†’ 0.6 | Detection Loss ê°€ì¤‘ì¹˜ (ì„ í˜• ì¦ê°€) |
| `lambda_fair` | 2.0 | Fairness Loss ê°€ì¤‘ì¹˜ |
| `lambda_w` | 0.2 | Wasserstein Loss ê°€ì¤‘ì¹˜ |
| `fair_f_scale` | 1.0 | Female fairness ìŠ¤ì¼€ì¼ |
| `fair_m_scale` | 0.5 | Male fairness ìŠ¤ì¼€ì¼ (ë‚®ì¶¤) |
| `alpha` | 0.2 | Entropy ê°€ì¤‘ì¹˜ |
| `k_d` | 4 | Discriminator ì—…ë°ì´íŠ¸ íšŸìˆ˜/iteration |
| `lr_g`, `lr_d` | 1e-4 | í•™ìŠµë¥  |
| `batch_size` | 4 | ë°°ì¹˜ í¬ê¸° |

---

## 1~7ì°¨ ì‹¤í—˜ ì „ì²´ ë¹„êµ

### Delta ì„±ëŠ¥ ë¹„êµ (Baseline ëŒ€ë¹„ ë³€í™”ëŸ‰)

| ì‹¤í—˜ | Male AP Î” | Female AP Î” | Male AR Î” | Female AR Î” | í‰ê°€ |
|------|-----------|-------------|-----------|-------------|------|
| **1st** | -0.0040 | -0.0146 | -0.0007 | -0.0012 | ë³´í†µ |
| **2nd** | +0.0005 | -0.0017 | +0.0018 | +0.0027 | ì¢‹ìŒ |
| **3rd** | -0.0149 | -0.0160 | -0.0062 | -0.0045 | ë‚˜ì¨ |
| **4th** | -0.0076 | -0.0078 | -0.0011 | +0.0044 | ë³´í†µ |
| **5th** | -0.0068 | -0.0087 | -0.0033 | +0.0012 | ë³´í†µ |
| **6th** | -0.0064 | -0.0093 | -0.0024 | -0.0001 | ë³´í†µ |
| **7th** | **+0.0029** | **+0.0034** | **+0.0021** | **+0.0070** | ğŸ† **ìµœê³ ** |

### ê³µì •ì„± Gap ë¹„êµ

| ì‹¤í—˜ | AP Gap ë³€í™” | AR Gap ë³€í™” | **ì¢…í•© ìˆœìœ„** |
|------|-------------|-------------|--------------|
| **7th** | -0.38% (ê°œì„ ) | **-60.5%** (ëŒ€í­ ê°œì„ ) | ğŸ¥‡ **1ìœ„** |
| **4th** | +0.02% (ìœ ì§€) | -55.0% (ê°œì„ ) | ğŸ¥ˆ 2ìœ„ |
| **2nd** | +2.2% (ì•…í™”) | -9.0% (ê°œì„ ) | ğŸ¥‰ 3ìœ„ |
| **5th** | +1.9% (ì•…í™”) | -45.0% (ê°œì„ ) | 4ìœ„ |
| **6th** | +2.9% (ì•…í™”) | -23.0% (ê°œì„ ) | 5ìœ„ |
| **3rd** | +1.1% (ì•…í™”) | -16.0% (ê°œì„ ) | 6ìœ„ |
| **1st** | +10.6% (ì•…í™”) | +5.0% (ì•…í™”) | 7ìœ„ |
