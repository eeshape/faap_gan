# FAAP 방법론 분석 및 최적 융합 전략 연구

**연구자**: AI 공정성 박사
**작성일**: 2026년 1월 6일

---

## 목차
1. [방법론 개요](#1-방법론-개요)
2. [Contrastive 1st 분석](#2-contrastive-1st-분석)
3. [GD 7th 분석](#3-gd-7th-분석)
4. [GD 10th 분석](#4-gd-10th-분석)
5. [성능 비교 요약](#5-성능-비교-요약)
6. [최적 융합 전략 연구](#6-최적-융합-전략-연구)
7. [제안 구현 방향](#7-제안-구현-방향)

---

## 1. 방법론 개요

세 가지 방법론은 모두 **Perturbation Generator**를 학습하여 이미지에 미세한 변형을 가해 DETR 객체 탐지기의 성별 간 공정성을 개선하는 것을 목표로 합니다. 그러나 각각 다른 학습 신호(Loss Function)를 사용합니다.

| 구분 | Contrastive 1st | GD 7th | GD 10th |
|------|-----------------|--------|---------|
| **핵심 접근** | 특징 공간 정렬 | 적대적 학습 + 분포 정렬 | 적대적 학습 + 다중 정렬 + Baseline 보호 |
| **Discriminator** | ❌ 없음 | ✅ 있음 | ✅ 있음 |
| **주요 손실** | InfoNCE + Feature Alignment | Wasserstein + Entropy | Wasserstein + Quantile + Uplift |
| **Epsilon** | 고정 0.08 | 동적 스케줄 (0.05→0.10→0.09) | 동적 스케줄 (0.05→0.10→0.08) |
| **학습 안정성** | 높음 (GAN 없음) | 중간 | 중간-높음 |

---

## 2. Contrastive 1st 분석

### 2.1 핵심 방법론

```
┌─────────────────────────────────────────────────────────┐
│                   Contrastive 1st                       │
├─────────────────────────────────────────────────────────┤
│  목표: 특징 공간에서 성별 정보 제거                       │
│                                                         │
│  [이미지] → [Generator] → [Perturbed 이미지]             │
│                              ↓                          │
│                         [DETR Features]                 │
│                              ↓                          │
│                      [Projection Head]                  │
│                              ↓                          │
│               ┌─────────────┴─────────────┐             │
│               ↓                           ↓             │
│         Male Features              Female Features      │
│               └─────────────┬─────────────┘             │
│                             ↓                           │
│                    Cross-Gender                         │
│                  Contrastive Loss                       │
│                    (InfoNCE 변형)                        │
└─────────────────────────────────────────────────────────┘
```

### 2.2 손실 함수 구성

```python
총 손실 = β × Detection_Loss 
        + λ_contrast × Cross_Gender_Contrastive_Loss
        + λ_align × Mean_Alignment_Loss
        + λ_var × Variance_Alignment_Loss
        + λ_score × Score_Distribution_Loss
```

**각 손실의 역할**:

| 손실 | 가중치 | 목적 |
|------|--------|------|
| Detection Loss | β=0.6 | 탐지 성능 유지 |
| Cross-Gender Contrastive | λ=1.0 | 다른 성별 특징을 positive pair로 취급 → 성별 구분 불가능하게 |
| Mean Alignment | λ=0.5 | Male/Female 평균 특징 벡터 일치 |
| Variance Alignment | λ=0.1 | Male/Female 특징 분산 일치 |
| Score Distribution | λ=0.3 | Detection score 분포 정렬 (단방향: Female→Male) |

### 2.3 핵심 혁신점

1. **Discriminator 제거**: GAN 학습의 불안정성(mode collapse) 회피
2. **InfoNCE 변형**: 전통적 contrastive와 달리 다른 성별을 positive로 취급
3. **Projection Head**: 128차원 저차원 공간에서 contrastive 학습

### 2.4 실험 결과

```
┌────────────────────────────────────────────────────────┐
│  Contrastive 1st 결과 (epsilon=0.08)                   │
├────────────────────────────────────────────────────────┤
│  Male AP:   51.08% → 51.44% (+0.36%)                  │
│  Female AP: 40.45% → 40.62% (+0.18%)                  │
│  AP Gap:    10.63% → 10.82% (+0.19%p, +1.79%)         │
│                                                        │
│  Male AR:   83.39% → 83.64% (+0.26%)                  │
│  Female AR: 82.58% → 83.33% (+0.76%)                  │
│  AR Gap:    0.81% → 0.31% (-0.50%p, -61.73%) ⭐       │
└────────────────────────────────────────────────────────┘
```

### 2.5 강점과 약점

| 강점 | 약점 |
|------|------|
| ✅ AR Gap 최대 감소 (-61.73%) | ❌ AP Gap 소폭 증가 (+1.79%) |
| ✅ 학습 안정성 (GAN 없음) | ❌ AP 절대 향상폭 작음 |
| ✅ Female AR 큰 폭 향상 (+0.76%) | ❌ 분포 정렬 효과 제한적 |
| ✅ 양측 성별 모두 성능 향상 | |

---

## 3. GD 7th 분석

### 3.1 핵심 방법론

```
┌─────────────────────────────────────────────────────────┐
│                       GD 7th                            │
├─────────────────────────────────────────────────────────┤
│  목표: 적대적 학습으로 성별 예측 불가능하게 +            │
│       Detection Score 분포 정렬                         │
│                                                         │
│  [이미지] → [Generator] → [Perturbed 이미지]             │
│                              ↓                          │
│                         [DETR Features]                 │
│                              ↓                          │
│               ┌─────────────┴─────────────┐             │
│               ↓                           ↓             │
│      [Gender Discriminator]      [Detection Outputs]    │
│               ↓                           ↓             │
│         Adversarial Loss          Wasserstein Loss      │
│         (+ Entropy Loss)          (단방향: F→M)         │
└─────────────────────────────────────────────────────────┘
```

### 3.2 손실 함수 구성

```python
# Generator 손실
G_Loss = β × Detection_Loss 
       + λ_fair × (Adversarial_Loss + α × Entropy_Loss)
       + λ_w × Wasserstein_Loss

# Discriminator 손실 (별도 학습)
D_Loss = BCE_Loss(discriminator(features), gender_labels)
```

**핵심 하이퍼파라미터**:

| 파라미터 | 값 | 설명 |
|----------|-----|------|
| epsilon | 0.05 → 0.10 → 0.09 | Warmup(8) → Hold(6) → Cooldown(10) |
| β | 0.5 → 0.6 | Detection 보호 가중치 (점진 증가) |
| λ_fair | 2.0 | Fairness 손실 가중치 |
| fair_f_scale | 1.0 | Female fairness 스케일 |
| fair_m_scale | 0.5 | Male fairness 스케일 (비대칭) |
| λ_w | 0.2 | Wasserstein 정렬 가중치 |
| k_d | 4 | Discriminator 업데이트 횟수/iteration |

### 3.3 핵심 혁신점

1. **Epsilon 스케줄**: Warmup → Hold → Cooldown으로 안정적 학습
2. **비대칭 Fairness**: Female(1.0) > Male(0.5) 가중치로 Female 중점 개선
3. **단방향 Wasserstein**: Female→Male 방향만 정렬 (Male 성능 보호)
4. **Beta 스케줄**: 후반부에 Detection 보호 강화

### 3.4 실험 결과

```
┌────────────────────────────────────────────────────────┐
│  GD 7th 결과 (epsilon=0.05→0.10→0.09)                 │
├────────────────────────────────────────────────────────┤
│  Male AP:   51.08% → 51.37% (+0.29%)                  │
│  Female AP: 40.45% → 40.78% (+0.34%)                  │
│  AP Gap:    10.63% → 10.59% (-0.04%p, -0.42%) ⭐⭐    │
│                                                        │
│  Male AR:   83.39% → 83.59% (+0.21%)                  │
│  Female AR: 82.58% → 83.28% (+0.70%)                  │
│  AR Gap:    0.81% → 0.32% (-0.49%p, -60.60%) ⭐       │
└────────────────────────────────────────────────────────┘
```

### 3.5 강점과 약점

| 강점 | 약점 |
|------|------|
| ✅ **유일하게 AP Gap 감소** (-0.42%) | ❌ AP 절대 향상폭 중간 수준 |
| ✅ AR Gap 큰 폭 감소 (-60.60%) | ❌ GAN 학습 불안정성 존재 |
| ✅ 양측 성별 모두 성능 향상 | ❌ 복잡한 스케줄 관리 필요 |
| ✅ Female AP 향상 > Male AP 향상 | |

---

## 4. GD 10th 분석

### 4.1 핵심 방법론

```
┌─────────────────────────────────────────────────────────┐
│                      GD 10th                            │
├─────────────────────────────────────────────────────────┤
│  목표: 7th 기반 + 다중 정렬 + Baseline 성능 보호          │
│                                                         │
│  [이미지] → [Generator] → [Perturbed 이미지]             │
│                              ↓                          │
│                         [DETR Features]                 │
│                              ↓                          │
│   ┌──────────────────────────┼──────────────────────┐   │
│   ↓                          ↓                      ↓   │
│ [Discriminator]     [Detection Outputs]     [Baseline] │
│   ↓                          ↓                      ↓   │
│ Adversarial      ┌───────────┼───────────┐    Uplift   │
│ + Entropy        ↓           ↓           ↓    Loss     │
│              Wasserstein  Quantile    Gap              │
│              Loss         Matching    Penalty          │
└─────────────────────────────────────────────────────────┘
```

### 4.2 손실 함수 구성 (가장 복잡)

```python
# Generator 손실
G_Loss = β × Detection_Loss 
       + λ_fair × (Adversarial_Loss + α × Entropy_Loss)
       + λ_w × Wasserstein_Loss
       + λ_q × Quantile_Matching_Loss      # 신규
       + λ_gap × Score_Gap_Penalty         # 신규
       + λ_det_guard × Detection_Guard     # 신규
       + λ_uplift × Baseline_Uplift_Loss   # 신규
```

**신규 손실 함수 상세**:

| 손실 | 가중치 | 역할 |
|------|--------|------|
| Quantile Matching | λ_q=0.15 | 분위수별 score 정렬 (높은 분위수에 높은 가중치) |
| Score Gap Penalty | λ_gap=0.1 | 평균 score 차이 직접 패널티 |
| Detection Guard | λ_det=0.7 | 성별별 detection 성능 하락 방지 |
| Baseline Uplift | λ_uplift=0.3 | Baseline 대비 성능 향상 강제 |

### 4.3 핵심 혁신점

1. **Adaptive Alignment**: 자동으로 낮은 그룹 → 높은 그룹 방향 정렬
2. **Quantile Matching**: AP 계산에 중요한 높은 score 영역 정밀 정렬
3. **Detection Guard**: 성별별 Detection 성능 하락 방지 (공정성과 성능 양립)
4. **Baseline Uplift**: Perturbed 결과가 항상 Baseline보다 좋도록 강제
5. **LR Decay**: 18 epoch 이후 학습률 0.5배 감소로 후반부 안정화

### 4.4 실험 결과

```
┌────────────────────────────────────────────────────────┐
│  GD 10th 결과 (epsilon=0.05→0.10→0.08)                │
├────────────────────────────────────────────────────────┤
│  Male AP:   51.08% → 51.98% (+0.90%) ⭐⭐             │
│  Female AP: 40.45% → 41.23% (+0.79%) ⭐⭐             │
│  AP Gap:    10.63% → 10.74% (+0.11%p, +1.03%)         │
│                                                        │
│  Male AR:   83.39% → 83.90% (+0.52%)                  │
│  Female AR: 82.58% → 83.27% (+0.69%)                  │
│  AR Gap:    0.81% → 0.63% (-0.18%p, -22.22%)          │
└────────────────────────────────────────────────────────┘
```

### 4.5 강점과 약점

| 강점 | 약점 |
|------|------|
| ✅ **최고 절대 성능** (Male 51.98%, Female 41.23%) | ❌ AP Gap 소폭 증가 (+1.03%) |
| ✅ 양측 성별 모두 큰 폭 향상 | ❌ 복잡한 손실 함수 구조 |
| ✅ Baseline 대비 확실한 개선 보장 | ❌ AR Gap 감소폭 중간 수준 (-22.22%) |
| ✅ Detection Guard로 성능 하락 방지 | ❌ 하이퍼파라미터 튜닝 어려움 |

---

## 5. 성능 비교 요약

### 5.1 종합 비교표

| 지표 | Contrastive 1st | GD 7th | GD 10th |
|------|-----------------|--------|---------|
| **Male AP Δ** | +0.36% | +0.29% | **+0.90%** |
| **Female AP Δ** | +0.18% | +0.34% | **+0.79%** |
| **AP Gap 상대변화** | +1.79% | **-0.42%** | +1.03% |
| **Male AR Δ** | +0.26% | +0.21% | **+0.52%** |
| **Female AR Δ** | **+0.76%** | +0.70% | +0.69% |
| **AR Gap 상대변화** | **-61.73%** | -60.60% | -22.22% |

### 5.2 Radar Chart 분석

```
                    절대 성능
                       ↑
                       │
          Contrastive ─┼─ GD 10th
              1st      │    ↗
                 ╲     │   ╱
                  ╲    │  ╱
    AR Gap 감소 ←──────┼──────→ AP Gap 감소
                  ╱    │  ╲
                 ╱     │   ╲
                      ─┼─
                    GD 7th
                       │
                       ↓
                   학습 안정성

■ GD 10th: 절대 성능 최고
■ GD 7th: AP Gap 감소 유일, 균형잡힌 성능
■ Contrastive 1st: AR Gap 감소 최대, 학습 안정성 최고
```

---

## 6. 최적 융합 전략 연구

### 6.1 문제 정의

각 방법론의 강점:
- **Contrastive 1st**: 특징 공간 정렬 → AR Gap 최대 감소
- **GD 7th**: 비대칭 fairness + 단방향 Wasserstein → AP Gap 유일 감소
- **GD 10th**: 다중 손실 + Baseline 보호 → 절대 성능 최대화

**목표**: 세 강점을 모두 취하는 융합 방법론 설계

### 6.2 융합 전략 A: "Contrastive-Guided GAN" (추천 ⭐⭐⭐)

```
┌─────────────────────────────────────────────────────────┐
│           Contrastive-Guided GAN (융합 전략 A)          │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  핵심 아이디어:                                          │
│  - GD 7th의 적대적 학습 프레임워크 유지                   │
│  - Contrastive 1st의 Projection Head + InfoNCE 추가     │
│  - GD 10th의 Detection Guard + Baseline Uplift 채용     │
│                                                         │
│  [이미지] → [Generator] → [Perturbed 이미지]             │
│                              ↓                          │
│                         [DETR Features]                 │
│                              ↓                          │
│   ┌──────────┬───────────────┼───────────────┐          │
│   ↓          ↓               ↓               ↓          │
│ [Disc.]  [Proj.Head]  [Detection]      [Baseline]      │
│   ↓          ↓               ↓               ↓          │
│ Advers.  Contrastive   Wasserstein     Uplift          │
│ Loss     Loss(InfoNCE) + Quantile      Loss            │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**손실 함수 설계**:

```python
G_Loss = 
    # === Detection 보호 (GD 10th) ===
    β × Detection_Loss
    + λ_uplift × Baseline_Uplift_Loss
    
    # === 적대적 공정성 (GD 7th) ===
    + λ_fair × (Adversarial_Loss + α × Entropy_Loss)
    
    # === 특징 공간 정렬 (Contrastive 1st) ===
    + λ_contrast × Cross_Gender_Contrastive_Loss
    + λ_align × Mean_Alignment_Loss
    
    # === 분포 정렬 (GD 7th + 10th 조합) ===
    + λ_w × Wasserstein_Loss
    + λ_q × Quantile_Matching_Loss
```

**하이퍼파라미터 제안**:

| 파라미터 | 값 | 출처 |
|----------|-----|------|
| epsilon | 0.05 → 0.10 → 0.08 | GD 10th |
| β | 0.5 → 0.65 | GD 10th |
| λ_fair | 1.5 (감소) | GD 7th (contrastive와 중복 고려) |
| λ_contrast | 0.5 (감소) | Contrastive 1st (GAN과 병행) |
| λ_align | 0.3 | Contrastive 1st |
| λ_w | 0.15 | GD 7th |
| λ_q | 0.10 | GD 10th |
| λ_uplift | 0.2 | GD 10th |

**예상 효과**:
- AP Gap: -0.3% ~ -0.8% (GD 7th 수준 또는 개선)
- AR Gap: -50% ~ -65% (Contrastive 1st 수준)
- 절대 성능: Male +0.7%, Female +0.6% (GD 10th에 근접)

---

### 6.3 융합 전략 B: "Two-Stage Training"

```
┌─────────────────────────────────────────────────────────┐
│            Two-Stage Training (융합 전략 B)             │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  Stage 1: Contrastive Pre-training (epoch 0-10)        │
│  ─────────────────────────────────────────────         │
│  - Discriminator 없이 순수 Contrastive 학습             │
│  - 특징 공간에서 성별 정보 제거                          │
│  - 목표: AR Gap 대폭 감소                               │
│                                                         │
│  Stage 2: GAN Fine-tuning (epoch 11-28)                │
│  ─────────────────────────────────────────────         │
│  - Discriminator 도입 + GD 10th 방식 학습               │
│  - Quantile Matching으로 AP Gap 정밀 조정               │
│  - Detection Guard로 성능 보호                         │
│  - 목표: AP Gap 감소 + 절대 성능 향상                   │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**장점**:
- Stage 1에서 안정적으로 특징 정렬 학습
- Stage 2에서 정교한 분포 조정 수행
- 각 단계의 목표가 명확

**단점**:
- 총 학습 시간 증가
- Stage 전환 시 하이퍼파라미터 재설정 필요

---

### 6.4 융합 전략 C: "Adaptive Loss Weighting"

```
┌─────────────────────────────────────────────────────────┐
│         Adaptive Loss Weighting (융합 전략 C)           │
├─────────────────────────────────────────────────────────┤
│                                                         │
│  핵심 아이디어:                                          │
│  현재 AP Gap / AR Gap 상태에 따라 손실 가중치 동적 조절  │
│                                                         │
│  if AP_Gap > threshold_ap:                             │
│      ↑ λ_w, λ_q (분포 정렬 강화)                        │
│      ↑ λ_fair (적대적 학습 강화)                        │
│                                                         │
│  if AR_Gap > threshold_ar:                             │
│      ↑ λ_contrast (특징 정렬 강화)                      │
│      ↑ λ_align (평균 정렬 강화)                         │
│                                                         │
│  if Both gaps low:                                     │
│      ↑ λ_uplift, β (성능 향상 집중)                     │
│                                                         │
└─────────────────────────────────────────────────────────┘
```

**구현 예시**:

```python
def adaptive_weights(ap_gap, ar_gap, base_weights):
    weights = base_weights.copy()
    
    # AP Gap이 클 때: 분포 정렬 강화
    if ap_gap > 0.10:  # 10% 초과
        weights['λ_w'] *= 1.5
        weights['λ_q'] *= 1.5
        weights['λ_fair'] *= 1.3
    
    # AR Gap이 클 때: 특징 정렬 강화
    if ar_gap > 0.005:  # 0.5% 초과
        weights['λ_contrast'] *= 1.5
        weights['λ_align'] *= 1.5
    
    # 둘 다 낮을 때: 성능 향상 집중
    if ap_gap <= 0.10 and ar_gap <= 0.005:
        weights['λ_uplift'] *= 1.5
        weights['β'] *= 1.1
    
    return weights
```

---

### 6.5 최종 권장: 융합 전략 A + C 조합

**"Adaptive Contrastive-Guided GAN"**

이 방법은:
1. **구조**: 융합 전략 A (Contrastive + GAN + Uplift)
2. **가중치**: 융합 전략 C (Adaptive Weighting)

```python
# === 최종 제안 손실 함수 ===
def compute_total_loss(features, outputs, targets, baseline_outputs, args, epoch):
    # 현재 Gap 계산
    ap_gap = compute_ap_gap(outputs, targets)
    ar_gap = compute_ar_gap(outputs, targets)
    
    # Adaptive 가중치
    weights = adaptive_weights(ap_gap, ar_gap, args)
    
    # Detection 보호
    det_loss = detr.criterion(outputs, targets)
    uplift_loss = compute_uplift_loss(outputs, baseline_outputs)
    
    # 적대적 공정성
    adv_loss = adversarial_loss(discriminator, features)
    ent_loss = entropy_loss(discriminator(features))
    
    # 특징 공간 정렬
    contrast_loss = cross_gender_contrastive(proj_head, features)
    align_loss = mean_alignment_loss(features)
    
    # 분포 정렬
    wass_loss = wasserstein_1d(female_scores, male_scores)
    quant_loss = quantile_matching(female_scores, male_scores)
    
    # 총 손실
    total = (
        weights['β'] * det_loss +
        weights['λ_uplift'] * uplift_loss +
        weights['λ_fair'] * (adv_loss + args.alpha * ent_loss) +
        weights['λ_contrast'] * contrast_loss +
        weights['λ_align'] * align_loss +
        weights['λ_w'] * wass_loss +
        weights['λ_q'] * quant_loss
    )
    
    return total
```

---

## 7. 제안 구현 방향

### 7.1 구현 우선순위

| 순위 | 작업 | 예상 효과 | 복잡도 |
|------|------|----------|--------|
| 1 | GD 10th에 Projection Head + Contrastive Loss 추가 | AR Gap ↓↓ | 중 |
| 2 | Adaptive Weighting 적용 | 균형 개선 | 중 |
| 3 | Two-Stage 실험 | 안정성 향상 | 높음 |

### 7.2 단계별 실험 계획

**Phase 1**: Contrastive Loss 추가 (1주)
```
GD 10th 코드베이스 + Contrastive 1st의:
- ProjectionHead 클래스
- _cross_gender_contrastive_loss 함수
- _feature_alignment_loss 함수
```

**Phase 2**: Adaptive Weighting (3일)
```
- Gap 계산 함수 구현
- 동적 가중치 스케줄러 구현
- 로깅 및 모니터링 추가
```

**Phase 3**: Two-Stage 실험 (1주)
```
- Stage 1: Contrastive 전용 학습 스크립트
- Stage 2: 체크포인트 로드 + GAN 학습
- 전환 로직 구현
```

### 7.3 기대 결과

**Best Case Scenario** (융합 전략 A + C):

```
┌────────────────────────────────────────────────────────┐
│  예상 최적 결과                                         │
├────────────────────────────────────────────────────────┤
│  Male AP:   51.08% → 51.85% (+0.77%)                  │
│  Female AP: 40.45% → 41.10% (+0.65%)                  │
│  AP Gap:    10.63% → 10.75% (+0.12%p) 또는 감소 가능   │
│                                                        │
│  Male AR:   83.39% → 83.80% (+0.41%)                  │
│  Female AR: 82.58% → 83.45% (+0.87%)                  │
│  AR Gap:    0.81% → 0.35% (-0.46%p, -56.79%)          │
│                                                        │
│  ✅ 양측 성별 모두 큰 폭 성능 향상                       │
│  ✅ AR Gap 50% 이상 감소                               │
│  ✅ AP Gap 유지 또는 소폭 감소                         │
└────────────────────────────────────────────────────────┘
```

---

## 8. 결론

### 8.1 핵심 발견

1. **Contrastive Learning**은 특징 공간에서 성별 정보를 효과적으로 제거하여 **AR Gap을 최대 61.73% 감소**시킴

2. **GD 7th의 비대칭 Fairness + 단방향 Wasserstein**은 **유일하게 AP Gap을 감소**시킨 방법론

3. **GD 10th의 다중 손실 + Detection Guard**는 **최고 절대 성능**을 달성

4. 세 방법론은 **서로 보완적인 강점**을 가지며, 융합 시 시너지 기대

### 8.2 최종 권장 사항

**단기 (1-2주)**:
- **Adaptive Contrastive-Guided GAN** 구현 및 실험
- GD 10th 코드베이스에 Contrastive Loss 추가

**중기 (2-4주)**:
- Two-Stage Training 실험
- Epsilon 스케줄 최적화 (0.06-0.08 범위 탐색)

**장기 (1-2개월)**:
- 다른 탐지 모델(YOLO, Faster R-CNN)로 일반화 검증
- 실제 데이터셋에서의 공정성 개선 효과 측정

---

*본 연구는 AI 공정성 분야에서 perturbation 기반 fairness 개선 방법론의 새로운 방향을 제시합니다. 세 가지 접근법의 강점을 융합함으로써, 탐지 성능과 공정성을 동시에 개선하는 실용적인 솔루션 개발이 가능합니다.*
